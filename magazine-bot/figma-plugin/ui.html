<!DOCTYPE html>
<html>
<head>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 12px;
    color: #e0e0e0;
    background: #2c2c2c;
    padding: 12px;
  }

  h2 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #fff;
  }

  .config {
    margin-bottom: 16px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .config label {
    font-size: 11px;
    color: #999;
    white-space: nowrap;
  }

  input {
    flex: 1;
    padding: 6px 8px;
    background: #1e1e1e;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    font-size: 11px;
    outline: none;
  }

  input:focus {
    border-color: #a259ff;
  }

  .issue-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }

  .issue-card {
    background: #383838;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .issue-card:hover {
    background: #444;
  }

  .issue-card .title {
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
  }

  .issue-card .meta {
    font-size: 11px;
    color: #888;
  }

  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
  }

  .btn-primary {
    background: #a259ff;
    color: #fff;
    width: 100%;
  }

  .btn-primary:hover {
    background: #b57aff;
  }

  .btn-primary:disabled {
    background: #555;
    color: #888;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #444;
    color: #e0e0e0;
    width: 100%;
    margin-top: 8px;
  }

  .btn-secondary:hover {
    background: #555;
  }

  .status {
    margin-top: 12px;
    padding: 8px;
    border-radius: 4px;
    font-size: 11px;
    display: none;
  }

  .status.info {
    background: #1a3a5c;
    color: #7db8f0;
    display: block;
  }

  .status.success {
    background: #1a3c1a;
    color: #7cf07c;
    display: block;
  }

  .status.error {
    background: #3c1a1a;
    color: #f07c7c;
    display: block;
  }

  .card-preview {
    margin: 8px 0;
    padding: 8px;
    background: #1e1e1e;
    border-radius: 4px;
    font-size: 11px;
  }

  .card-preview .card-item {
    padding: 4px 0;
    border-bottom: 1px solid #333;
  }

  .card-preview .card-item:last-child {
    border-bottom: none;
  }

  .card-type {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    margin-right: 6px;
  }

  .card-type.cover { background: #a259ff33; color: #a259ff; }
  .card-type.description { background: #59a2ff33; color: #59a2ff; }
  .card-type.whisky { background: #f5a62333; color: #f5a623; }
  .card-type.closing { background: #ff925933; color: #ff9259; }

  .hidden { display: none; }

  .loading {
    text-align: center;
    padding: 20px;
    color: #888;
  }

  .thread-link {
    display: block;
    margin-top: 8px;
    padding: 8px;
    background: #1a3a5c;
    border-radius: 4px;
    color: #7db8f0;
    text-decoration: none;
    font-size: 11px;
    text-align: center;
  }

  .thread-link:hover {
    background: #235080;
  }

  .tip {
    font-size: 10px;
    color: #888;
    margin-top: 8px;
    line-height: 1.4;
  }
</style>
</head>
<body>
  <h2>BottleNote Magazine</h2>

  <div class="config">
    <label>API URL</label>
    <input type="text" id="apiUrl" value="https://bottlenote-magazine-bot.fly.dev" />
  </div>

  <div id="view-list">
    <button class="btn-primary" onclick="loadIssues()">ì´ìŠˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="issueList" class="issue-list" style="margin-top: 12px;"></div>
  </div>

  <div id="view-detail" class="hidden">
    <button class="btn-secondary" onclick="showList()" style="margin-top:0;margin-bottom:12px;">â† ëª©ë¡ìœ¼ë¡œ</button>
    <div id="issueDetail"></div>
    <div id="cardPreview" class="card-preview hidden"></div>
    <button class="btn-primary" id="btnPopulate" onclick="populateCards()" style="margin-top:12px;" disabled>
      ë°°ì¹˜ ì‹œì‘
    </button>
    <div class="tip">ğŸ’¡ í”„ë ˆì„ì„ ì„ íƒí•œ ìƒíƒœì—ì„œ ë°°ì¹˜í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ ì˜†ì— ì¹´ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤.</div>
  </div>

  <div id="status" class="status"></div>

<script>
  let currentIssueId = null;
  let currentCards = null;

  function getApiUrl() {
    return document.getElementById('apiUrl').value.replace(/\/$/, '');
  }

  function setStatus(msg, type) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status ' + type;
  }

  function showList() {
    document.getElementById('view-list').classList.remove('hidden');
    document.getElementById('view-detail').classList.add('hidden');
    currentIssueId = null;
    currentCards = null;
  }

  async function loadIssues() {
    setStatus('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');

    try {
      const res = await fetch(getApiUrl() + '/api/issues');
      if (!res.ok) throw new Error('API ì—°ê²° ì‹¤íŒ¨');
      const issues = await res.json();

      const list = document.getElementById('issueList');
      if (issues.length === 0) {
        list.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">ë ˆì´ì•„ì›ƒ ëŒ€ê¸° ì¤‘ì¸ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        setStatus('', '');
        return;
      }

      list.innerHTML = issues.map(function(issue) {
        return '<div class="issue-card" onclick="loadIssue(' + issue.id + ')">' +
          '<div class="title">ì´ìŠˆ #' + issue.issueNumber + '</div>' +
          '<div class="meta">' + new Date(issue.createdAt).toLocaleDateString('ko-KR') + '</div>' +
        '</div>';
      }).join('');

      setStatus('', '');
    } catch (e) {
      setStatus('API ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
    }
  }

  async function loadIssue(id) {
    setStatus('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
    currentIssueId = id;

    try {
      const res = await fetch(getApiUrl() + '/api/issues/' + id + '/layout');
      if (!res.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      const data = await res.json();

      currentCards = data.cards;

      document.getElementById('view-list').classList.add('hidden');
      document.getElementById('view-detail').classList.remove('hidden');

      var threadLink = data.threadUrl
        ? '<a href="' + data.threadUrl + '" target="_blank" class="thread-link">ğŸ“‹ Discordì—ì„œ í•´ì‹œíƒœê·¸ í™•ì¸</a>'
        : '';

      document.getElementById('issueDetail').innerHTML =
        '<div style="margin-bottom:8px;">' +
          '<div style="font-weight:600;color:#fff;font-size:13px;">ì´ìŠˆ #' + data.issueNumber + '</div>' +
          '<div style="color:#a259ff;margin-top:2px;">' + data.topic.title + '</div>' +
          '<div style="color:#888;font-size:11px;">' + data.topic.subtitle + '</div>' +
          threadLink +
        '</div>';

      var preview = document.getElementById('cardPreview');
      preview.classList.remove('hidden');
      preview.innerHTML = data.cards.map(function(card) {
        var hasImg = card.imageRef ? ' ğŸ”—' : '';
        var tagsBadge = card.tags && card.tags.length > 0
          ? ' <span style="color:#888;font-size:10px;">[' + card.tags.join(', ') + ']</span>'
          : '';
        return '<div class="card-item">' +
          '<span class="card-type ' + card.type + '">' + card.type + '</span>' +
          card.heading + hasImg + tagsBadge +
        '</div>';
      }).join('');

      document.getElementById('btnPopulate').disabled = false;
      setStatus(data.cards.length + 'ê°œ ì¹´ë“œ ì¤€ë¹„ ì™„ë£Œ', 'success');
    } catch (e) {
      setStatus('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
    }
  }

  function populateCards() {
    if (!currentCards) return;

    setStatus('Figmaì— ë°°ì¹˜ ì¤‘...', 'info');
    document.getElementById('btnPopulate').disabled = true;

    parent.postMessage({
      pluginMessage: {
        type: 'populate-template',
        cards: currentCards
      }
    }, '*');
  }

  // Listen for messages from plugin code
  window.onmessage = async function(event) {
    var msg = event.data.pluginMessage;
    if (!msg) return;

    if (msg.type === 'populate-complete') {
      setStatus('ë°°ì¹˜ ì™„ë£Œ! APIì— ì™„ë£Œ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ì¤‘...', 'info');

      try {
        var res = await fetch(getApiUrl() + '/api/issues/' + currentIssueId + '/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!res.ok) throw new Error('ì™„ë£Œ ì•Œë¦¼ ì‹¤íŒ¨');

        setStatus('ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } catch (e) {
        setStatus('ë°°ì¹˜ëŠ” ì™„ë£Œë˜ì—ˆì§€ë§Œ API ì•Œë¦¼ ì‹¤íŒ¨: ' + e.message, 'error');
      }
    }
  };
</script>
</body>
</html>
